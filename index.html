<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>75hard Advanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* LIGHT MODE DEFAULTS (Soft Clay) */
            --bg-base: #e6ebf2;
            --bg-surface: #e6ebf2;
            --text-main: #4a5568;
            --text-sub: #889bb0;
            
            /* Shadows for 3D effect */
            --shadow-light: #ffffff;
            --shadow-dark: #b8c4d6;
            
            /* Accents */
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.3);
            --danger: #ef4444;
            
            /* Glass */
            --glass-bg: rgba(230, 235, 242, 0.85);
        }

        /* DARK MODE VARS (Reusable) */
        .dark-vars {
            --bg-base: #1a1c20;
            --bg-surface: #1a1c20;
            --text-main: #e2e8f0;
            --text-sub: #64748b;
            --shadow-light: #26292e; 
            --shadow-dark: #0f1012; 
            --accent: #60a5fa;
            --accent-glow: rgba(96, 165, 250, 0.2);
            --glass-bg: rgba(26, 28, 32, 0.85);
        }

        /* LIGHT MODE VARS (Reusable for forcing light on dark system) */
        .light-vars {
            --bg-base: #e6ebf2;
            --bg-surface: #e6ebf2;
            --text-main: #4a5568;
            --text-sub: #889bb0;
            --shadow-light: #ffffff;
            --shadow-dark: #b8c4d6;
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.3);
            --glass-bg: rgba(230, 235, 242, 0.85);
        }

        /* System Preference (Default) */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-base: #1a1c20;
                --bg-surface: #1a1c20;
                --text-main: #e2e8f0;
                --text-sub: #64748b;
                --shadow-light: #26292e; 
                --shadow-dark: #0f1012; 
                --accent: #60a5fa;
                --accent-glow: rgba(96, 165, 250, 0.2);
                --glass-bg: rgba(26, 28, 32, 0.85);
            }
        }

        /* Manual Overrides */
        [data-theme="dark"] {
            --bg-base: #1a1c20;
            --bg-surface: #1a1c20;
            --text-main: #e2e8f0;
            --text-sub: #64748b;
            --shadow-light: #26292e; 
            --shadow-dark: #0f1012; 
            --accent: #60a5fa;
            --accent-glow: rgba(96, 165, 250, 0.2);
            --glass-bg: rgba(26, 28, 32, 0.85);
        }

        [data-theme="light"] {
            --bg-base: #e6ebf2;
            --bg-surface: #e6ebf2;
            --text-main: #4a5568;
            --text-sub: #889bb0;
            --shadow-light: #ffffff;
            --shadow-dark: #b8c4d6;
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.3);
            --glass-bg: rgba(230, 235, 242, 0.85);
        }

        body {
            background-color: var(--bg-base);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
            overscroll-behavior-y: none;
            padding-bottom: env(safe-area-inset-bottom);
            transition: background-color 0.4s ease, color 0.4s ease;
        }

        /* --- ADVANCED NEUMORPHIC UTILITIES --- */

        /* 1. The Convex Object (Popping Out) */
        .neu-flat {
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(0,0,0,0.02));
            background-color: var(--bg-surface);
            box-shadow: 
                6px 6px 12px var(--shadow-dark), 
                -6px -6px 12px var(--shadow-light);
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* 2. The Concave Object (Pressed In) */
        .neu-pressed {
            background-color: var(--bg-surface);
            box-shadow: 
                inset 5px 5px 10px var(--shadow-dark), 
                inset -5px -5px 10px var(--shadow-light);
            border-radius: 16px;
        }

        /* 3. Soft Interactive Button */
        .neu-btn {
            background: var(--bg-surface);
            box-shadow: 
                6px 6px 12px var(--shadow-dark), 
                -6px -6px 12px var(--shadow-light);
            border-radius: 16px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Button Active State (Physical Press) */
        .neu-btn:active, .neu-btn.active-state {
            transform: scale(0.98);
            box-shadow: 
                inset 4px 4px 8px var(--shadow-dark), 
                inset -4px -4px 8px var(--shadow-light);
        }

        /* 4. Glassmorphism Sticky Bars */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        /* --- SPECIFIC COMPONENTS --- */

        /* Toggle Button / Checkbox */
        .neu-toggle {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: var(--text-sub);
        }
        
        .neu-toggle.checked {
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent-glow);
            box-shadow: 
                inset 3px 3px 6px var(--shadow-dark), 
                inset -3px -3px 6px var(--shadow-light),
                0 0 0 2px var(--bg-surface), /* Spacer */
                0 0 0 3px var(--accent); /* Outer Ring */
        }

        /* Task Card styling */
        .task-card {
            transition: transform 0.2s ease;
        }
        .task-card:active {
            transform: scale(0.99);
        }

        /* Progress Ring Container */
        .ring-container {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            /* Deep inset for track feel */
            box-shadow: 
                inset 4px 4px 8px var(--shadow-dark), 
                inset -4px -4px 8px var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
            100% { transform: translateY(0px); }
        }
        
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 var(--accent-glow); }
            70% { box-shadow: 0 0 0 6px rgba(0,0,0,0); }
            100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
        }

        .animate-float { animation: float 4s ease-in-out infinite; }
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }

        /* View Transitions */
        .view-section { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
        .view-section.active { display: block; opacity: 1; transform: translateY(0); }
        
        input[type="file"] { display: none; }
        
        /* Typography Polish */
        .tracking-ultra { letter-spacing: 0.2em; }
    </style>
</head>
<body class="min-h-screen">

    <!-- HOME VIEW -->
    <div id="view-home" class="view-section active pb-32">
        
        <!-- Glass Header -->
        <header class="fixed top-0 left-0 right-0 glass-panel px-6 pt-12 pb-4 z-50 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-black italic tracking-tighter text-accent uppercase leading-none drop-shadow-sm">75hard</h1>
                <div class="flex items-center space-x-2 mt-2">
                    <span class="text-[10px] font-bold text-sub uppercase tracking-ultra py-1">Smart Tracker</span>
                    <span id="notifyBadge" class="hidden flex items-center gap-1 text-[9px] font-bold text-emerald-500 uppercase bg-emerald-500/10 px-2 py-0.5 rounded-full border border-emerald-500/20">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span> Active
                    </span>
                </div>
            </div>
            <div onclick="openDayEdit()" class="neu-btn px-4 py-2 cursor-pointer active:scale-95 transition-transform">
                <div class="text-center">
                    <div class="text-[9px] font-bold text-sub uppercase tracking-wider mb-0.5">Day</div>
                    <span id="dayDisplay" class="text-2xl font-black leading-none text-main">1</span>
                </div>
            </div>
        </header>
        
        <!-- Spacer for fixed header -->
        <div class="h-32"></div>

        <main class="px-5 space-y-8">
            
            <!-- Hero Progress Card -->
            <div class="neu-flat p-6 flex justify-between items-center relative overflow-hidden animate-float">
                <div class="z-10 relative">
                    <h2 class="text-xs font-bold text-sub uppercase tracking-widest mb-1">Daily Discipline</h2>
                    <div class="text-5xl font-black italic text-accent" id="percentageText" style="text-shadow: 2px 2px 4px var(--shadow-dark);">0%</div>
                    <p class="text-[10px] text-sub mt-2 font-medium">ZERO COMPROMISE</p>
                </div>
                
                <!-- Inset Progress Ring -->
                <div class="ring-container">
                     <svg class="w-full h-full transform -rotate-90 p-2">
                        <!-- Track -->
                        <circle cx="50%" cy="50%" r="28" stroke="transparent" stroke-width="6" fill="transparent"/>
                        <!-- Indicator -->
                        <circle id="progressRing" cx="50%" cy="50%" r="28" stroke="var(--accent)" stroke-width="6" fill="transparent" stroke-dasharray="175.9" stroke-dashoffset="175.9" stroke-linecap="round" class="transition-all duration-1000 ease-out drop-shadow-md"/>
                    </svg>
                    <!-- Inner Shine -->
                    <div class="absolute inset-0 rounded-full shadow-[inset_2px_2px_4px_rgba(255,255,255,0.1)] pointer-events-none"></div>
                </div>
            </div>
            
            <!-- Settings Button -->
            <button onclick="goToSettings()" class="neu-btn w-full py-4 text-xs font-bold text-sub flex items-center justify-center space-x-3 group">
                <i class="fa-solid fa-sliders group-active:rotate-90 transition-transform duration-300"></i>
                <span class="tracking-widest">CONFIGURE & BACKUP</span>
            </button>

            <!-- Task List -->
            <div id="taskList" class="space-y-5 pt-2">
                <!-- Injected via JS -->
            </div>

            <!-- Danger Zone -->
            <div class="pt-8 pb-4 flex justify-center">
                <button onclick="confirmFail()" class="px-6 py-3 text-[10px] font-bold text-danger/70 hover:text-danger uppercase tracking-[0.2em] transition-colors">
                    I Failed. Reset.
                </button>
            </div>
        </main>

        <!-- Glass Footer -->
        <div class="fixed bottom-0 left-0 right-0 p-6 z-50 glass-panel border-t border-t-white/5">
            <button id="finishBtn" onclick="finishDay()" class="neu-btn w-full h-16 text-sub font-black text-lg italic uppercase tracking-wider transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <span>Complete Day</span>
            </button>
        </div>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="view-settings" class="view-section min-h-screen bg-base pb-10">
        <header class="px-6 pt-12 pb-8 flex items-center sticky top-0 z-20" style="background-color: var(--bg-base);">
            <button onclick="goHome()" class="neu-btn w-10 h-10 rounded-full mr-5 text-sub">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h2 class="text-2xl font-black italic uppercase text-accent">Settings</h2>
        </header>

        <main class="px-6 space-y-8">
            
            <!-- Appearance -->
            <section>
                <h3 class="text-[10px] font-black text-sub uppercase tracking-ultra mb-4 ml-2">Appearance</h3>
                <div class="neu-flat p-4 flex items-center justify-between">
                    <div>
                        <span class="text-xs font-bold text-main uppercase tracking-wide">Dark Mode</span>
                        <p class="text-[9px] text-sub mt-0.5" id="themeLabel">System Default</p>
                    </div>
                    <!-- Toggle Switch -->
                    <button onclick="toggleTheme()" id="themeBtn" class="neu-pressed w-14 h-8 rounded-full p-1 relative transition-colors duration-300">
                        <div id="themeToggleCircle" class="w-6 h-6 rounded-full bg-sub shadow-md transform transition-transform duration-300 translate-x-0"></div>
                    </button>
                </div>
            </section>

            <!-- Notifications -->
            <section>
                <h3 class="text-[10px] font-black text-sub uppercase tracking-ultra mb-4 ml-2">Smart Alerts</h3>
                <div class="neu-flat p-6">
                    <p class="text-xs text-sub mb-5 leading-relaxed">Enable local alerts to get notified only if a task is incomplete by its deadline.</p>
                    <button onclick="requestPermission()" id="permBtn" class="neu-btn w-full py-3 text-accent font-bold text-xs uppercase tracking-wider">
                        Enable Notifications
                    </button>
                    <div id="permActive" class="hidden neu-pressed w-full py-3 text-emerald-500 font-bold text-xs uppercase flex items-center justify-center tracking-wider">
                        <i class="fa-solid fa-check-circle mr-2"></i> Active
                    </div>
                </div>
            </section>

            <!-- Deadlines -->
            <section>
                <h3 class="text-[10px] font-black text-sub uppercase tracking-ultra mb-4 ml-2">Deadlines</h3>
                <div class="neu-flat p-2 space-y-1" id="timeSettings"></div>
            </section>

            <!-- Data -->
            <section>
                <h3 class="text-[10px] font-black text-sub uppercase tracking-ultra mb-4 ml-2">Data</h3>
                <div class="neu-flat p-5">
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="exportData()" class="neu-btn py-4 text-sub font-bold text-[10px] uppercase flex flex-col items-center gap-2 hover:text-accent transition-colors">
                            <i class="fa-solid fa-download text-lg"></i>
                            <span>Backup File</span>
                        </button>
                        <button onclick="document.getElementById('importInput').click()" class="neu-btn py-4 text-sub font-bold text-[10px] uppercase flex flex-col items-center gap-2 hover:text-accent transition-colors">
                            <i class="fa-solid fa-upload text-lg"></i>
                            <span>Restore File</span>
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- DAY EDIT MODAL -->
    <div id="dayModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm">
        <div class="neu-flat w-full max-w-xs p-8 text-center" onclick="event.stopPropagation()">
            <h3 class="text-xl font-black italic uppercase mb-2 text-main">Override Day</h3>
            <input type="number" id="dayInput" class="neu-pressed w-full text-center font-black text-4xl py-6 mb-6 text-accent bg-transparent border-none outline-none" placeholder="1">
            <div class="flex space-x-4">
                <button onclick="closeDayEdit()" class="neu-btn flex-1 py-3 font-bold text-xs text-sub uppercase">Cancel</button>
                <button onclick="saveDayEdit()" class="neu-btn flex-1 py-3 font-bold text-xs text-white bg-accent uppercase shadow-lg shadow-blue-500/30">Update</button>
            </div>
        </div>
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment">
    <input type="file" id="importInput" accept=".json" onchange="importData(this)">

    <script>
        /* --- CONFIGURATION --- */
        const TASKS = [
            { id: 'diet', label: 'Strict Diet', sub: 'Zero Alcohol / Cheats', icon: 'fa-utensils', defaultTime: '20:00' },
            { id: 'workout1', label: 'Workout 1', sub: '45 Mins', icon: 'fa-dumbbell', defaultTime: '10:00' },
            { id: 'workout2', label: 'Workout 2', sub: '45 Mins Outdoor', icon: 'fa-person-running', defaultTime: '18:00' },
            { id: 'water', label: 'Gallon Water', sub: 'Pure Water', icon: 'fa-glass-water', defaultTime: '21:00' },
            { id: 'read', label: 'Reading', sub: '10 Pages Non-Fiction', icon: 'fa-book-open', defaultTime: '21:30' },
            { id: 'photo', label: 'Progress Photo', sub: 'Daily Evidence', icon: 'fa-camera', type: 'photo', defaultTime: '22:00' }
        ];

        /* --- STATE --- */
        let state = { day: 1, checks: {}, deadlines: {}, alertsEnabled: false, history: [], theme: 'system' };

        /* --- INIT --- */
        function init() {
            const saved = localStorage.getItem('75hard_smart_v2'); // New version key
            if (saved) { state = JSON.parse(saved); } 
            else { TASKS.forEach(t => state.deadlines[t.id] = t.defaultTime); }
            
            // Ensure theme property exists
            if (!state.theme) state.theme = 'system';
            applyTheme();

            renderTasks();
            renderSettings();
            updateUI();
            checkNotificationPermission();
            setInterval(runSmartCheck, 60000);
        }

        /* --- RENDERERS --- */
        function renderTasks() {
            const container = document.getElementById('taskList');
            container.innerHTML = '';
            
            TASKS.forEach(task => {
                const isChecked = state.checks[task.id];
                const deadline = state.deadlines[task.id];
                const div = document.createElement('div');
                
                div.className = `neu-flat task-card p-4 flex items-center justify-between cursor-pointer select-none group ${isChecked ? 'border-blue-500/20' : ''}`;
                
                // Photo triggers camera, others toggle
                const clickHandler = task.type === 'photo' ? `triggerCamera('${task.id}')` : `toggle('${task.id}')`;
                div.onclick = () => eval(clickHandler);

                div.innerHTML = `
                    <div class="flex items-center space-x-5 flex-1">
                        <div class="neu-btn w-12 h-12 flex items-center justify-center text-lg transition-colors duration-300 ${isChecked ? 'text-accent' : 'text-sub'}">
                            <i class="fa-solid ${task.icon}"></i>
                        </div>
                        <div>
                            <div class="font-bold text-sm tracking-wide transition-colors ${isChecked ? 'text-accent' : 'text-main'}">${task.label}</div>
                            <div class="text-[10px] font-bold text-sub uppercase tracking-wider opacity-70">${task.sub}</div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <!-- Smart Toggle (Pressed Effect) -->
                        <div class="neu-pressed w-8 h-8 flex items-center justify-center transition-all duration-300 ${isChecked ? 'shadow-none bg-accent/10' : ''}">
                            <i class="fa-solid fa-check text-sm transition-all duration-300 ${isChecked ? 'scale-100 text-accent' : 'scale-0 text-transparent'}"></i>
                        </div>
                        <div class="text-[9px] font-bold text-sub opacity-50 font-mono">${formatTime12(deadline)}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderSettings() {
            const container = document.getElementById('timeSettings');
            container.innerHTML = '';
            TASKS.forEach(task => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-4 border-b border-gray-500/5 last:border-0";
                div.innerHTML = `
                    <span class="text-xs font-bold text-sub flex items-center uppercase tracking-wide">
                        <i class="fa-solid ${task.icon} w-6 text-center mr-2 opacity-70"></i> ${task.label}
                    </span>
                    <input type="time" value="${state.deadlines[task.id] || task.defaultTime}" 
                        onchange="updateDeadline('${task.id}', this.value)"
                        class="neu-pressed py-2 px-3 text-xs font-bold w-24 text-center text-main bg-transparent outline-none focus:text-accent">
                `;
                container.appendChild(div);
            });
            updateThemeUI();
        }

        /* --- THEME HANDLING --- */
        function applyTheme() {
            const html = document.documentElement;
            // Clear manually set attributes first
            html.removeAttribute('data-theme');

            if (state.theme === 'dark') {
                html.setAttribute('data-theme', 'dark');
            } else if (state.theme === 'light') {
                html.setAttribute('data-theme', 'light');
            } else {
                // System default - remove attr to let media query take over, OR check media query
                // Since our CSS relies on [data-theme] to OVERRIDE, removing it enables default @media behavior
                // The CSS structure was: Light default, Dark @media, Dark/Light override.
            }
            updateThemeUI();
        }

        function toggleTheme() {
            // Cycle: System -> Light -> Dark -> System
            if (state.theme === 'system') state.theme = 'light';
            else if (state.theme === 'light') state.theme = 'dark';
            else state.theme = 'system';
            
            save();
            applyTheme();
        }

        function updateThemeUI() {
            const btn = document.getElementById('themeBtn');
            const circle = document.getElementById('themeToggleCircle');
            const label = document.getElementById('themeLabel');
            if(!btn || !circle) return;

            if (state.theme === 'dark') {
                circle.style.transform = 'translateX(24px)';
                circle.classList.replace('bg-sub', 'bg-accent');
                label.innerText = 'Dark Mode';
            } else if (state.theme === 'light') {
                circle.style.transform = 'translateX(0px)';
                circle.classList.replace('bg-sub', 'bg-white'); // Highlight for forced light
                circle.classList.remove('bg-accent'); 
                label.innerText = 'Light Mode';
            } else {
                // System
                const isSysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                circle.style.transform = 'translateX(12px)'; // Middle
                circle.classList.replace('bg-accent', 'bg-sub');
                circle.classList.replace('bg-white', 'bg-sub');
                label.innerText = `System (${isSysDark ? 'Dark' : 'Light'})`;
            }
        }

        /* --- ACTIONS --- */
        function toggle(id) {
            state.checks[id] = !state.checks[id];
            save(); renderTasks(); updateUI();
            if(window.navigator.vibrate) window.navigator.vibrate(15);
        }

        function triggerCamera(id) {
            if(state.checks[id]) { toggle(id); return; }
            const input = document.getElementById('cameraInput');
            input.onchange = (e) => { if(e.target.files[0]) toggle(id); };
            input.click();
        }

        function updateDeadline(id, time) {
            state.deadlines[id] = time;
            save(); renderTasks(); 
        }

        function finishDay() {
            const allDone = TASKS.every(t => state.checks[t.id]);
            if(!allDone) return;

            generateVictoryLink(state.day);
            state.history.push({ day: state.day, date: new Date().toISOString() });
            state.day++;
            state.checks = {}; 
            save(); renderTasks(); updateUI();
            
            setTimeout(() => { exportData(); }, 1000);
            setTimeout(() => { alert(`DAY ${state.day - 1} COMPLETE.\nFiles saved.`); }, 1500);
        }

        /* --- UI HELPERS --- */
        function updateUI() {
            document.getElementById('dayDisplay').innerText = state.day;
            document.getElementById('dayInput').value = state.day;

            const doneCount = Object.values(state.checks).filter(v => v).length;
            const pct = Math.round((doneCount / TASKS.length) * 100);
            
            document.getElementById('percentageText').innerText = pct + '%';
            
            // Ring Calculation
            const circumference = 175.9; 
            const offset = circumference - ((pct / 100) * circumference);
            document.getElementById('progressRing').style.strokeDashoffset = offset;

            // Finish Button State
            const btn = document.getElementById('finishBtn');
            if(pct === 100) {
                btn.disabled = false;
                btn.classList.add('active-state', 'text-accent');
                btn.classList.remove('text-sub');
                btn.innerHTML = `FINISH DAY ${state.day} <i class="fa-solid fa-arrow-right ml-2 animate-pulse"></i>`;
            } else {
                btn.disabled = true;
                btn.classList.remove('active-state', 'text-accent');
                btn.classList.add('text-sub');
                btn.innerText = `${doneCount} / ${TASKS.length} COMPLETE`;
            }
        }

        function goToSettings() {
            document.getElementById('view-home').classList.remove('active');
            setTimeout(() => document.getElementById('view-settings').classList.add('active'), 100);
            window.scrollTo(0,0);
        }
        function goHome() {
            document.getElementById('view-settings').classList.remove('active');
            setTimeout(() => document.getElementById('view-home').classList.add('active'), 100);
            window.scrollTo(0,0);
        }
        function openDayEdit() { document.getElementById('dayModal').classList.remove('hidden'); }
        function closeDayEdit() { document.getElementById('dayModal').classList.add('hidden'); }
        function saveDayEdit() {
            const val = parseInt(document.getElementById('dayInput').value);
            if(val > 0 && val <= 75) { state.day = val; save(); updateUI(); closeDayEdit(); }
        }

        /* --- UTILS --- */
        function formatTime12(t) {
            if(!t) return "--:--";
            let [h, m] = t.split(':'); h = parseInt(h);
            const amp = h >= 12 ? 'PM' : 'AM';
            h = h % 12; h = h ? h : 12; 
            return `${h}:${m}${amp}`;
        }
        function save() { localStorage.setItem('75hard_smart_v2', JSON.stringify(state)); }
        
        /* --- NOTIFICATIONS & FILES (Same logic as before) --- */
        function runSmartCheck() {
            if (!state.alertsEnabled) return;
            const now = new Date();
            const cur = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            TASKS.forEach(t => {
                if (state.deadlines[t.id] === cur && !state.checks[t.id]) {
                    if (Notification.permission === "granted") new Notification(`75HARD: ${t.label}`, {body:"Incomplete."});
                }
            });
        }
        function requestPermission() {
            if (!("Notification" in window)) return;
            Notification.requestPermission().then(p => {
                if(p === "granted") { state.alertsEnabled=true; save(); checkNotificationPermission(); }
            });
        }
        function checkNotificationPermission() {
            if (Notification.permission === "granted") {
                state.alertsEnabled=true; 
                document.getElementById('notifyBadge').classList.remove('hidden');
                document.getElementById('permBtn').classList.add('hidden');
                document.getElementById('permActive').classList.remove('hidden');
            }
        }
        function exportData() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(state)],{type:'application/json'}));
            a.download = "75hard_backup.json"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function importData(inp) {
            const f = inp.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => { 
                try { 
                    const d = JSON.parse(e.target.result); 
                    if(d.day && confirm(`Restore Day ${d.day}?`)) { state=d; save(); init(); alert("Restored."); }
                } catch(err){ alert("Invalid file"); }
            };
            r.readAsText(f); inp.value='';
        }
        function generateVictoryLink(d) {
            const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
            const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nDTSTART;VALUE=DATE:${date}\nSUMMARY:âœ… 75HARD Day ${d} DONE\nEND:VEVENT\nEND:VCALENDAR`;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([ics],{type:'text/calendar'}));
            a.download = `75Hard_Day${d}_Victory.ics`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function confirmFail() { if(confirm("Restart at Day 1?")) { state.day=1; state.checks={}; save(); init(); } }

        window.onload = init;
    </script>
</body>
</html>
